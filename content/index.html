<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessible Morse Code Decoder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-weight: bold;
            font-size: 0.9em;
        }

        input, button, select {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1em;
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            min-height: 45px;
            font-size: 1.1em;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .permissions-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9em;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-granted {
            color: #4CAF50;
            font-weight: bold;
        }

        .status-denied {
            color: #f44336;
            font-weight: bold;
        }

        .status-prompt {
            color: #ff9800;
            font-weight: bold;
        }

        .info-icon {
            font-size: 0.8em;
            color: #ffd700;
            cursor: help;
            margin-left: 5px;
        }

        .status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 1.1em;
        }

        .visualizer {
            height: 150px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .volume-history {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
        }

        .volume-bar-history {
            width: 2px;
            background: linear-gradient(to top, #00ff00, #ffff00, #ff0000);
            margin-right: 1px;
            transition: none;
        }

        .threshold-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #ff6b6b;
            z-index: 2;
            box-shadow: 0 0 5px #ff6b6b;
        }

        .current-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.8em;
        }

        .timing-display {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .timing-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            min-width: 100px;
        }

        .output-section {
            margin: 20px 0;
        }

        .output-section h3 {
            margin-bottom: 10px;
            color: #ffd700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .output {
            min-height: 80px;
            max-height: 200px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            line-height: 1.4;
            word-break: break-all;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
        }

        .history-controls {
            display: flex;
            gap: 10px;
            font-size: 0.9em;
        }

        .history-controls button {
            padding: 5px 10px;
            font-size: 0.8em;
            min-height: auto;
        }

        .morse-history {
            background: rgba(0, 0, 0, 0.5);
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .history-item {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .timestamp {
            font-size: 0.7em;
            color: #ccc;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .preset-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            font-size: 0.9em;
            min-height: 40px;
        }

        .morse-reference {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-size: 0.8em;
        }

        .morse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 5px;
            margin-top: 10px;
        }

        .morse-item {
            text-align: center;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .sensitivity-indicator {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            text-align: center;
        }

        .volume-level {
            font-weight: bold;
            font-size: 1.1em;
            margin: 5px 0;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .timing-display {
                flex-direction: column;
                gap: 10px;
            }
        }
        .tooltip {
    position: relative;
    display: inline-block;
}

.tooltip .tooltiptext {
    visibility: hidden;
    width: 250px;
    background-color: rgba(0, 0, 0, 0.9);
    color: #fff;
    text-align: left;
    border-radius: 8px;
    padding: 10px;
    position: absolute;
    z-index: 1000;
    bottom: 125%;
    left: 50%;
    margin-left: -125px;
    opacity: 0;
    transition: opacity 0.3s, visibility 0.3s;
    font-size: 0.85em;
    line-height: 1.3;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.tooltip .tooltiptext::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
}

.tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
}

.profile-section {
    margin: 20px 0;
    padding: 20px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
}

.profile-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.profile-btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    min-width: 120px;
    position: relative;
}

.profile-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.profile-btn.active {
    background: linear-gradient(45deg, #11998e, #38ef7d);
}

.profile-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.profile-name-input {
    padding: 8px 12px;
    border-radius: 5px;
    border: none;
    background: rgba(255, 255, 255, 0.9);
    color: #333;
    font-size: 0.9em;
    min-width: 150px;
}

.save-btn, .delete-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8em;
    font-weight: bold;
}

.save-btn {
    background: #28a745;
    color: white;
}

.delete-btn {
    background: #dc3545;
    color: white;
}
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Morse Code Decoder</h1>
        
        <div class="permissions-status" id="permissionsStatus">
            <div class="status-item">
                <span>üé§ Microphone:</span> <span id="micStatus">Click Start to check</span>
            </div>
            <div class="status-item">
                <span>üîä Text-to-Speech:</span> <span id="ttsStatus">Checking...</span>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="threshold" class="tooltip">Volume Threshold <span class="info-icon">‚ÑπÔ∏è</span>
                    <span class="tooltiptext">Set how loud sounds need to be to register as signals. Lower values detect quieter sounds. Adjust so it's just above your background noise level but below your intentional sounds.</span>
                </label>
                <input type="range" id="threshold" min="5" max="95" value="30">
                <span id="thresholdValue">30</span>
                <div class="sensitivity-indicator">
                    <div>Current Volume: <span id="currentVolume" class="volume-level">0</span></div>
                    <div style="font-size: 0.8em; margin-top: 5px;">Adjust threshold so it's just below your quiet sounds</div>
                </div>
            </div>
            
            <div class="control-group">
                <label for="dotLength" class="tooltip">Short Sound Duration (ms) <span class="info-icon">‚ÑπÔ∏è</span>
                    <span class="tooltiptext">How long a sound needs to be to register as a "dot" (short signal). Sounds shorter than this are ignored. Sounds longer than this times the multiplier become "dashes" (long signals).</span>
                </label>
                <input type="range" id="dotLength" min="50" max="1000" value="200">
                <span id="dotLengthValue">200ms</span>
            </div>
            
            <div class="control-group">
                <label for="dashMultiplier" class="tooltip">Long Sound Multiplier <span class="info-icon">‚ÑπÔ∏è</span>
                    <span class="tooltiptext">How much longer a sound needs to be to register as a "dash" instead of a "dot". For example, 2.5x means dashes need to be 2.5 times longer than the dot duration.</span>
                </label>
                <input type="range" id="dashMultiplier" min="1.5" max="5" value="2.5" step="0.1">
                <span id="dashMultiplierValue">2.5x</span>
            </div>
            
            <div class="control-group">
                <label for="letterGap" class="tooltip">Letter Gap (ms) <span class="info-icon">‚ÑπÔ∏è</span>
                    <span class="tooltiptext">How long to pause between dots/dashes to indicate the end of a letter. When you pause this long, the system converts your dots and dashes into a letter.</span>
                </label>
                <input type="range" id="letterGap" min="300" max="2000" value="600">
                <span id="letterGapValue">600ms</span>
            </div>
            
            <div class="control-group">
                <label for="wordGap" class="tooltip">Word Gap (ms) <span class="info-icon">‚ÑπÔ∏è</span>
                    <span class="tooltiptext">How long to pause to indicate the end of a word. When you pause this long, the system adds a space between words in your decoded text.</span>
                </label>
                <input type="range" id="wordGap" min="800" max="4000" value="1500">
                <span id="wordGapValue">1500ms</span>
            </div>
        </div>

        <div class="profile-section">
          <h4>‚öôÔ∏è Settings Profiles</h4>
          <div class="profile-buttons">
              <button class="profile-btn" id="profile1Btn" onclick="decoder.loadProfile(1)">Profile 1</button>
              <button class="profile-btn" id="profile2Btn" onclick="decoder.loadProfile(2)">Profile 2</button>
              <button class="profile-btn" id="profile3Btn" onclick="decoder.loadProfile(3)">Profile 3</button>
          </div>
          <div class="profile-controls">
              <input type="text" id="profileName" class="profile-name-input" placeholder="Enter profile name..." maxlength="20">
              <button class="save-btn" onclick="decoder.saveCurrentProfile()">üíæ Save Current</button>
              <button class="delete-btn" onclick="decoder.deleteCurrentProfile()">üóëÔ∏è Delete</button>
          </div>
      </div>

        <div style="text-align: center; margin: 20px 0;">
            <button id="startBtn">üé§ Start Listening</button>
            <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
            <button id="clearBtn">üóëÔ∏è Clear All</button>
            <button id="testSpeakerBtn">üîä Test Speaker</button>
        </div>

        <div class="status" id="status">Click "Start Listening" to begin</div>

        <div class="visualizer">
            <div class="volume-history" id="volumeHistory"></div>
            <div class="threshold-line" id="thresholdLine"></div>
            <div class="current-indicator">‚Üê Current</div>
        </div>

        <div class="timing-display">
            <div class="timing-item">
                <div>Current Signal</div>
                <div id="currentSignal">-</div>
            </div>
            <div class="timing-item">
                <div>Signal Duration</div>
                <div id="signalDuration">0ms</div>
            </div>
            <div class="timing-item">
                <div>Gap Duration</div>
                <div id="gapDuration">0ms</div>
            </div>
            <div class="timing-item">
                <div>Last Symbol</div>
                <div id="lastSymbol">-</div>
            </div>
        </div>

        <div class="output-section">
            <h3>
                Current Morse Code:
                <div class="history-controls">
                    <button onclick="decoder.copyCurrentMorse()">üìã Copy</button>
                </div>
            </h3>
            <div class="output" id="morseOutput"></div>
        </div>

        <div class="output-section">
            <h3>
                Decoded Text:
                <div class="history-controls">
                    <button onclick="decoder.copyCurrentText()">üìã Copy</button>
                    <button onclick="decoder.speakText()">üîä Speak</button>
                </div>
            </h3>
            <div class="output" id="textOutput"></div>
        </div>

        <div class="output-section">
            <h3>
                Morse Code History:
                <div class="history-controls">
                    <button onclick="decoder.clearHistory()">üóëÔ∏è Clear History</button>
                    <button onclick="decoder.exportHistory()">üì• Export</button>
                </div>
            </h3>
            <div class="output morse-history" id="historyOutput"></div>
        </div>

        <div class="morse-reference">
            <h4>Morse Code Reference:</h4>
            <div class="morse-grid">
                <div class="morse-item">A: ¬∑‚àí</div>
                <div class="morse-item">B: ‚àí¬∑¬∑¬∑</div>
                <div class="morse-item">C: ‚àí¬∑‚àí¬∑</div>
                <div class="morse-item">D: ‚àí¬∑¬∑</div>
                <div class="morse-item">E: ¬∑</div>
                <div class="morse-item">F: ¬∑¬∑‚àí¬∑</div>
                <div class="morse-item">G: ‚àí‚àí¬∑</div>
                <div class="morse-item">H: ¬∑¬∑¬∑¬∑</div>
                <div class="morse-item">I: ¬∑¬∑</div>
                <div class="morse-item">J: ¬∑‚àí‚àí‚àí</div>
                <div class="morse-item">K: ‚àí¬∑‚àí</div>
                <div class="morse-item">L: ¬∑‚àí¬∑¬∑</div>
                <div class="morse-item">M: ‚àí‚àí</div>
                <div class="morse-item">N: ‚àí¬∑</div>
                <div class="morse-item">O: ‚àí‚àí‚àí</div>
                <div class="morse-item">P: ¬∑‚àí‚àí¬∑</div>
                <div class="morse-item">Q: ‚àí‚àí¬∑‚àí</div>
                <div class="morse-item">R: ¬∑‚àí¬∑</div>
                <div class="morse-item">S: ¬∑¬∑¬∑</div>
                <div class="morse-item">T: ‚àí</div>
                <div class="morse-item">U: ¬∑¬∑‚àí</div>
                <div class="morse-item">V: ¬∑¬∑¬∑‚àí</div>
                <div class="morse-item">W: ¬∑‚àí‚àí</div>
                <div class="morse-item">X: ‚àí¬∑¬∑‚àí</div>
                <div class="morse-item">Y: ‚àí¬∑‚àí‚àí</div>
                <div class="morse-item">Z: ‚àí‚àí¬∑¬∑</div>
                <div class="morse-item">1: ¬∑‚àí‚àí‚àí‚àí</div>
                <div class="morse-item">2: ¬∑¬∑‚àí‚àí‚àí</div>
                <div class="morse-item">3: ¬∑¬∑¬∑‚àí‚àí</div>
                <div class="morse-item">4: ¬∑¬∑¬∑¬∑‚àí</div>
                <div class="morse-item">5: ¬∑¬∑¬∑¬∑¬∑</div>
                <div class="morse-item">6: ‚àí¬∑¬∑¬∑¬∑</div>
                <div class="morse-item">7: ‚àí‚àí¬∑¬∑¬∑</div>
                <div class="morse-item">8: ‚àí‚àí‚àí¬∑¬∑</div>
                <div class="morse-item">9: ‚àí‚àí‚àí‚àí¬∑</div>
                <div class="morse-item">0: ‚àí‚àí‚àí‚àí‚àí</div>
            </div>
        </div>
    </div>

    <script>
        class AccessibleMorseDecoder {
            constructor() {
                this.audioContext = null;
                this.analyser = null;
                this.microphone = null;
                this.dataArray = null;
                this.isListening = false;
                
                this.threshold = 30;
                this.dotLength = 200;
                this.dashMultiplier = 2.5;
                this.letterGap = 600;
                this.wordGap = 1500;
                
                this.currentSignalStart = null;
                this.currentGapStart = null;
                this.isSignalActive = false;
                this.morseBuffer = '';
                this.currentLetter = '';
                this.volumeHistory = [];
                this.maxHistoryLength = 300;
                this.sessionHistory = [];

                this.currentProfile = 1;
this.profiles = {
    1: { name: 'Profile 1', settings: null },
    2: { name: 'Profile 2', settings: null },
    3: { name: 'Profile 3', settings: null }
};
this.loadProfilesFromStorage();
                
                this.morseToText = {
                    '¬∑‚àí': 'A', '‚àí¬∑¬∑¬∑': 'B', '‚àí¬∑‚àí¬∑': 'C', '‚àí¬∑¬∑': 'D', '¬∑': 'E',
                    '¬∑¬∑‚àí¬∑': 'F', '‚àí‚àí¬∑': 'G', '¬∑¬∑¬∑¬∑': 'H', '¬∑¬∑': 'I', '¬∑‚àí‚àí‚àí': 'J',
                    '‚àí¬∑‚àí': 'K', '¬∑‚àí¬∑¬∑': 'L', '‚àí‚àí': 'M', '‚àí¬∑': 'N', '‚àí‚àí‚àí': 'O',
                    '¬∑‚àí‚àí¬∑': 'P', '‚àí‚àí¬∑‚àí': 'Q', '¬∑‚àí¬∑': 'R', '¬∑¬∑¬∑': 'S', '‚àí': 'T',
                    '¬∑¬∑‚àí': 'U', '¬∑¬∑¬∑‚àí': 'V', '¬∑‚àí‚àí': 'W', '‚àí¬∑¬∑‚àí': 'X', '‚àí¬∑‚àí‚àí': 'Y',
                    '‚àí‚àí¬∑¬∑': 'Z', '¬∑‚àí‚àí‚àí‚àí': '1', '¬∑¬∑‚àí‚àí‚àí': '2', '¬∑¬∑¬∑‚àí‚àí': '3', '¬∑¬∑¬∑¬∑‚àí': '4',
                    '¬∑¬∑¬∑¬∑¬∑': '5', '‚àí¬∑¬∑¬∑¬∑': '6', '‚àí‚àí¬∑¬∑¬∑': '7', '‚àí‚àí‚àí¬∑¬∑': '8', '‚àí‚àí‚àí‚àí¬∑': '9',
                    '‚àí‚àí‚àí‚àí‚àí': '0'
                };
                
                this.presets = {
                    breathing: { threshold: 15, dotLength: 400, dashMultiplier: 2.0, letterGap: 800, wordGap: 2000 },
                    clicks: { threshold: 25, dotLength: 150, dashMultiplier: 2.5, letterGap: 500, wordGap: 1200 },
                    vocal: { threshold: 35, dotLength: 200, dashMultiplier: 2.2, letterGap: 600, wordGap: 1500 },
                    whistle: { threshold: 40, dotLength: 180, dashMultiplier: 2.8, letterGap: 550, wordGap: 1300 }
                };
                
                this.initializeElements();
                this.setupEventListeners();
            }
            
            initializeElements() {
                this.elements = {
                    startBtn: document.getElementById('startBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    clearBtn: document.getElementById('clearBtn'),
                    testSpeakerBtn: document.getElementById('testSpeakerBtn'),
                    status: document.getElementById('status'),
                    volumeHistory: document.getElementById('volumeHistory'),
                    thresholdLine: document.getElementById('thresholdLine'),
                    morseOutput: document.getElementById('morseOutput'),
                    textOutput: document.getElementById('textOutput'),
                    historyOutput: document.getElementById('historyOutput'),
                    currentSignal: document.getElementById('currentSignal'),
                    signalDuration: document.getElementById('signalDuration'),
                    gapDuration: document.getElementById('gapDuration'),
                    lastSymbol: document.getElementById('lastSymbol'),
                    currentVolume: document.getElementById('currentVolume'),
                    micStatus: document.getElementById('micStatus'),
                    ttsStatus: document.getElementById('ttsStatus'),
                    threshold: document.getElementById('threshold'),
                    thresholdValue: document.getElementById('thresholdValue'),
                    dotLength: document.getElementById('dotLength'),
                    dotLengthValue: document.getElementById('dotLengthValue'),
                    dashMultiplier: document.getElementById('dashMultiplier'),
                    dashMultiplierValue: document.getElementById('dashMultiplierValue'),
                    letterGap: document.getElementById('letterGap'),
                    letterGapValue: document.getElementById('letterGapValue'),
                    wordGap: document.getElementById('wordGap'),
                    wordGapValue: document.getElementById('wordGapValue')
                };
                
                this.checkTTSSupport();
            }
            saveState() {
    const state = {
        settings: this.getCurrentSettings(),
        text: this.elements.textOutput.textContent,
        morse: this.elements.morseOutput.textContent,
        history: this.sessionHistory
    };
    localStorage.setItem("decoderState", JSON.stringify(state));
}

loadState() {
    const state = JSON.parse(localStorage.getItem("decoderState") || "null");
    if (state) {
        this.applySettings(state.settings);
        this.elements.textOutput.textContent = state.text || '';
        this.elements.morseOutput.textContent = state.morse || '';
        this.sessionHistory = state.history || [];
        this.updateHistoryDisplay();
    }
}
            setupEventListeners() {
                this.elements.startBtn.addEventListener('click', () => this.startListening());
                this.elements.stopBtn.addEventListener('click', () => this.stopListening());
                this.elements.clearBtn.addEventListener('click', () => this.clearAll());
                this.elements.testSpeakerBtn.addEventListener('click', () => this.testSpeaker());
                
                // Setup parameter controls
                this.elements.threshold.addEventListener('input', (e) => {
                    this.threshold = parseInt(e.target.value);
                    this.elements.thresholdValue.textContent = this.threshold;
                    this.updateThresholdLine();
                });
                
                this.elements.dotLength.addEventListener('input', (e) => {
                    this.dotLength = parseInt(e.target.value);
                    this.elements.dotLengthValue.textContent = this.dotLength + 'ms';
                });
                
                this.elements.dashMultiplier.addEventListener('input', (e) => {
                    this.dashMultiplier = parseFloat(e.target.value);
                    this.elements.dashMultiplierValue.textContent = this.dashMultiplier + 'x';
                });
                
                this.elements.letterGap.addEventListener('input', (e) => {
                    this.letterGap = parseInt(e.target.value);
                    this.elements.letterGapValue.textContent = this.letterGap + 'ms';
                });
                
                this.elements.wordGap.addEventListener('input', (e) => {
                    this.wordGap = parseInt(e.target.value);
                    this.elements.wordGapValue.textContent = this.wordGap + 'ms';
                });
                
                this.updateThresholdLine();
                window.addEventListener("beforeunload", () => this.saveState());
            }
            
            checkTTSSupport() {
                if ('speechSynthesis' in window) {
                    this.elements.ttsStatus.textContent = 'Available';
                    this.elements.ttsStatus.className = 'status-granted';
                } else {
                    this.elements.ttsStatus.textContent = 'Not Available';
                    this.elements.ttsStatus.className = 'status-denied';
                }
            }
            
            testSpeaker() {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('Test message: The Morse code decoder is working correctly. You should hear this message clearly.');
                    utterance.rate = 0.8;
                    utterance.pitch = 1;
                    utterance.volume = 0.8;
                    speechSynthesis.speak(utterance);
                    this.elements.status.textContent = 'üîä Playing test message through speakers...';
                    
                    utterance.onend = () => {
                        this.elements.status.textContent = '‚úÖ Speaker test completed';
                    };
                    
                    utterance.onerror = () => {
                        this.elements.status.textContent = '‚ùå Speaker test failed';
                    };
                } else {
                    this.elements.status.textContent = '‚ùå Text-to-speech not available in this browser';
                }
            }
            
            updateThresholdLine() {
                const percentage = this.threshold;
                this.elements.thresholdLine.style.bottom = percentage + '%';
            }
            
            playTestSound() {
                if (!this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                
                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + 0.2);
                
                this.elements.status.textContent = 'üîä Test sound played - check if volume bar responds';
            }
            
            async startListening() {
                try {
                    this.elements.micStatus.textContent = 'Requesting...';
                    this.elements.micStatus.className = 'status-prompt';
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { 
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        } 
                    });
                    
                    this.elements.micStatus.textContent = 'Granted';
                    this.elements.micStatus.className = 'status-granted';
                    
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    this.microphone = this.audioContext.createMediaStreamSource(stream);
                    
                    this.analyser.fftSize = 256;
                    this.analyser.smoothingTimeConstant = 0.3;
                    this.microphone.connect(this.analyser);
                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    
                    this.isListening = true;
                    this.elements.startBtn.disabled = true;
                    this.elements.stopBtn.disabled = false;
                    this.elements.status.textContent = 'üé§ Listening... Make sounds to generate Morse code';
                    
                    this.analyze();
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    this.elements.micStatus.textContent = 'Denied';
                    this.elements.micStatus.className = 'status-denied';
                    this.elements.status.textContent = '‚ùå Microphone access denied. Please allow microphone access and refresh the page.';
                }
            }
            
            stopListening() {
                this.isListening = false;
                if (this.audioContext) {
                    this.audioContext.close();
                }
                this.elements.startBtn.disabled = false;
                this.elements.stopBtn.disabled = true;
                this.elements.status.textContent = '‚èπÔ∏è Stopped listening';
                this.processEndOfInput();
            }
            
            clearAll() {
                this.elements.morseOutput.textContent = '';
                this.elements.textOutput.textContent = '';
                this.morseBuffer = '';
                this.currentLetter = '';
                this.elements.currentSignal.textContent = '-';
                this.elements.signalDuration.textContent = '0ms';
                this.elements.gapDuration.textContent = '0ms';
                this.elements.lastSymbol.textContent = '-';
                this.volumeHistory = [];
                this.updateVolumeHistory();
            }
            
            clearHistory() {
                this.sessionHistory = [];
                this.elements.historyOutput.innerHTML = '';
            }
            
            analyze() {
                if (!this.isListening) return;
                
                this.analyser.getByteFrequencyData(this.dataArray);
                
                // Calculate RMS (Root Mean Square) for better volume detection
                let sum = 0;
                for (let i = 0; i < this.dataArray.length; i++) {
                    sum += this.dataArray[i] * this.dataArray[i];
                }
                const rms = Math.sqrt(sum / this.dataArray.length);
                const volume = (rms / 255) * 100;
                
                // Add to volume history
                this.volumeHistory.push(volume);
                if (this.volumeHistory.length > this.maxHistoryLength) {
                    this.volumeHistory.shift();
                }
                
                this.updateVolumeHistory();
                this.elements.currentVolume.textContent = Math.round(volume);
                
                const now = Date.now();
                const isAboveThreshold = volume > this.threshold;
                
                if (isAboveThreshold && !this.isSignalActive) {
                    // Signal started
                    this.isSignalActive = true;
                    this.currentSignalStart = now;
                    if (this.currentGapStart) {
                        const gapDuration = now - this.currentGapStart;
                        this.elements.gapDuration.textContent = gapDuration + 'ms';
                        this.processGap(gapDuration);
                    }
                    this.elements.currentSignal.textContent = 'üîä Signal';
                } else if (!isAboveThreshold && this.isSignalActive) {
                    // Signal ended
                    this.isSignalActive = false;
                    this.currentGapStart = now;
                    if (this.currentSignalStart) {
                        const signalDuration = now - this.currentSignalStart;
                        this.elements.signalDuration.textContent = signalDuration + 'ms';
                        this.processSignal(signalDuration);
                    }
                    this.elements.currentSignal.textContent = 'üîá Gap';
                }
                
                // Update current durations in real time
                if (this.isSignalActive && this.currentSignalStart) {
                    this.elements.signalDuration.textContent = (now - this.currentSignalStart) + 'ms';
                } else if (!this.isSignalActive && this.currentGapStart) {
                    this.elements.gapDuration.textContent = (now - this.currentGapStart) + 'ms';
                }
                
                requestAnimationFrame(() => this.analyze());
            }
            
            updateVolumeHistory() {
                this.elements.volumeHistory.innerHTML = '';
                
                this.volumeHistory.forEach(volume => {
                    const bar = document.createElement('div');
                    bar.className = 'volume-bar-history';
                    bar.style.height = Math.min(volume * 1.5, 100) + '%';
                    this.elements.volumeHistory.appendChild(bar);
                });
            }
            
            processSignal(duration) {
                const dashThreshold = this.dotLength * this.dashMultiplier;
                const symbol = duration >= dashThreshold ? '‚àí' : '¬∑';
                this.currentLetter += symbol;
                this.elements.lastSymbol.textContent = symbol + ` (${duration}ms)`;
                this.updateMorseOutput();
            }
            
            processGap(duration) {
                if (duration >= this.wordGap) {
                    // Word gap
                    this.processLetter();
                    this.addSpace();
                    this.saveToHistory();
                } else if (duration >= this.letterGap) {
                    // Letter gap
                    this.processLetter();
                }
            }
            
            processLetter() {
                if (this.currentLetter) {
                    const letter = this.morseToText[this.currentLetter] || '?';
                    this.elements.textOutput.textContent += letter;
                    this.currentLetter = '';
                    this.updateMorseOutput();
                }
            }
            
            addSpace() {
                this.elements.textOutput.textContent += ' ';
            }
            
            processEndOfInput() {
                if (this.currentLetter) {
                    this.processLetter();
                }
                this.saveToHistory();
            }
            
            updateMorseOutput() {
                let output = this.elements.morseOutput.textContent;
                // Remove the last incomplete letter and add the current one
                const lastSpaceIndex = output.lastIndexOf(' ');
                if (lastSpaceIndex !== -1) {
                    output = output.substring(0, lastSpaceIndex + 1);
                } else {
                    output = '';
                }
                output += this.currentLetter;
                this.elements.morseOutput.textContent = output;
                
                // Auto-scroll to bottom
                this.elements.morseOutput.scrollTop = this.elements.morseOutput.scrollHeight;
            }
            
            saveToHistory() {
                const morseCode = this.elements.morseOutput.textContent.trim();
                const text = this.elements.textOutput.textContent.trim();
                
                if (morseCode || text) {
                    const timestamp = new Date().toLocaleTimeString();
                    this.sessionHistory.push({
                        timestamp,
                        morse: morseCode,
                        text: text
                    });
                    
                    this.updateHistoryDisplay();
                }
            }
            
            updateHistoryDisplay() {
                this.elements.historyOutput.innerHTML = '';
                
                this.sessionHistory.forEach((entry, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div>
                            <div><strong>${entry.text || 'No translation'}</strong></div>
                            <div style="font-size: 0.8em; color: #ccc;">${entry.morse || 'No morse code'}</div>
                        </div>
                        <div class="timestamp">${entry.timestamp}</div>
                    `;
                    
                    historyItem.addEventListener('click', () => {
                        this.restoreFromHistory(entry);
                    });
                    
                    this.elements.historyOutput.appendChild(historyItem);
                });
                
                // Auto-scroll to bottom
                this.elements.historyOutput.scrollTop = this.elements.historyOutput.scrollHeight;
            }
            
            restoreFromHistory(entry) {
                this.elements.morseOutput.textContent = entry.morse;
                this.elements.textOutput.textContent = entry.text;
                this.elements.status.textContent = `Restored from history: ${entry.timestamp}`;
            }
            
            copyCurrentMorse() {
                const text = this.elements.morseOutput.textContent;
                if (text) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.elements.status.textContent = 'üìã Morse code copied to clipboard';
                    }).catch(() => {
                        this.elements.status.textContent = '‚ùå Failed to copy morse code';
                    });
                }
            }
            
            copyCurrentText() {
                const text = this.elements.textOutput.textContent;
                if (text) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.elements.status.textContent = 'üìã Text copied to clipboard';
                    }).catch(() => {
                        this.elements.status.textContent = '‚ùå Failed to copy text';
                    });
                }
            }
            
            speakText() {
                const text = this.elements.textOutput.textContent;
                if (text && 'speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.8;
                    utterance.pitch = 1;
                    speechSynthesis.speak(utterance);
                    this.elements.status.textContent = 'üîä Speaking decoded text...';
                } else {
                    this.elements.status.textContent = '‚ùå Speech synthesis not available';
                }
            }
            
            exportHistory() {
                if (this.sessionHistory.length === 0) {
                    this.elements.status.textContent = '‚ùå No history to export';
                    return;
                }
                
                let exportData = 'Morse Code Session History\n';
                exportData += '================================\n\n';
                
                this.sessionHistory.forEach((entry, index) => {
                    exportData += `Entry ${index + 1} - ${entry.timestamp}\n`;
                    exportData += `Text: ${entry.text || 'No translation'}\n`;
                    exportData += `Morse: ${entry.morse || 'No morse code'}\n`;
                    exportData += '---\n\n';
                });
                
                const blob = new Blob([exportData], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `morse_history_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.elements.status.textContent = 'üì• History exported successfully';
            }
            getCurrentSettings() {
    return {
        threshold: this.threshold,
        dotLength: this.dotLength,
        dashMultiplier: this.dashMultiplier,
        letterGap: this.letterGap,
        wordGap: this.wordGap
    };
}

applySettings(settings) {
    this.threshold = settings.threshold;
    this.dotLength = settings.dotLength;
    this.dashMultiplier = settings.dashMultiplier;
    this.letterGap = settings.letterGap;
    this.wordGap = settings.wordGap;
    
    // Update UI
    this.elements.threshold.value = this.threshold;
    this.elements.thresholdValue.textContent = this.threshold;
    this.elements.dotLength.value = this.dotLength;
    this.elements.dotLengthValue.textContent = this.dotLength + 'ms';
    this.elements.dashMultiplier.value = this.dashMultiplier;
    this.elements.dashMultiplierValue.textContent = this.dashMultiplier + 'x';
    this.elements.letterGap.value = this.letterGap;
    this.elements.letterGapValue.textContent = this.letterGap + 'ms';
    this.elements.wordGap.value = this.wordGap;
    this.elements.wordGapValue.textContent = this.wordGap + 'ms';
    
    this.updateThresholdLine();
}

loadProfile(profileNumber) {
    this.currentProfile = profileNumber;
    const profile = this.profiles[profileNumber];
    
    if (profile.settings) {
        this.applySettings(profile.settings);
        this.elements.status.textContent = `Loaded profile: ${profile.name}`;
    }
    
    document.getElementById('profileName').value = profile.name;
    this.updateProfileButtons();
}

saveCurrentProfile() {
    const profileName = document.getElementById('profileName').value.trim() || `Profile ${this.currentProfile}`;
    
    this.profiles[this.currentProfile] = {
        name: profileName,
        settings: this.getCurrentSettings()
    };
    
    this.saveProfilesToStorage();
    this.updateProfileButtons();
    this.elements.status.textContent = `Saved profile: ${profileName}`;
}

deleteCurrentProfile() {
    const profile = this.profiles[this.currentProfile];
    
    this.profiles[this.currentProfile] = {
        name: `Profile ${this.currentProfile}`,
        settings: null
    };
    
    document.getElementById('profileName').value = this.profiles[this.currentProfile].name;
    this.saveProfilesToStorage();
    this.updateProfileButtons();
    this.elements.status.textContent = `Deleted profile: ${profile.name}`;
}

updateProfileButtons() {
    for (let i = 1; i <= 3; i++) {
        const btn = document.getElementById(`profile${i}Btn`);
        const profile = this.profiles[i];
        
        btn.textContent = profile.name;
        btn.classList.toggle('active', i === this.currentProfile);
    }
}

saveProfilesToStorage() {
    try {
        const data = JSON.stringify(this.profiles);
        document.cookie = `morseProfiles=${data}; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/`;
    } catch (error) {
        console.error('Failed to save profiles:', error);
    }
}

loadProfilesFromStorage() {
    try {
        const cookies = document.cookie.split(';');
        const profileCookie = cookies.find(cookie => cookie.trim().startsWith('morseProfiles='));
        
        if (profileCookie) {
            const data = profileCookie.split('=')[1];
            this.profiles = JSON.parse(data);
        }
        
        // Load the first available profile or Profile 1
        for (let i = 1; i <= 3; i++) {
            if (this.profiles[i] && this.profiles[i].settings) {
                this.loadProfile(i);
                break;
            }
        }
        
        this.updateProfileButtons();
    } catch (error) {
        console.error('Failed to load profiles:', error);
    }
}
        }
        
        // Initialize the decoder when the page loads
        let decoder;
        document.addEventListener('DOMContentLoaded', () => {
            decoder = new AccessibleMorseDecoder();
            decoder.loadState();
        });
    </script>
</body>
</html>
